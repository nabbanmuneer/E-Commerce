<!DOCTYPE html>
<!--
Template: Metronic Frontend Freebie - Responsive HTML Template Based On Twitter Bootstrap 3.3.4
Version: 1.0.0
Author: KeenThemes
Website: http://www.keenthemes.com/
Contact: support@keenthemes.com
Follow: www.twitter.com/keenthemes
Like: www.facebook.com/keenthemes
Purchase Premium Metronic Admin Theme: http://themeforest.net/item/metronic-responsive-admin-dashboard-template/4021469?ref=keenthemes
-->
<!--[if IE 8]> <html lang="en" class="ie8 no-js"> <![endif]-->
<!--[if IE 9]> <html lang="en" class="ie9 no-js"> <![endif]-->
<!--[if !IE]><!-->
<html lang="en">
<!--<![endif]-->

<!-- Head BEGIN -->
<head>
  <%-include("./partials/head")%>
</head>
<!-- Head END -->

<!-- Body BEGIN -->
<body class="ecommerce">
    <!-- BEGIN STYLE CUSTOMIZER -->
    <%-include("./partials/header")%>
    <!-- END TOP BAR -->

    <!-- BEGIN HEADER -->
    <!-- Header END -->
    
    <div class="main" style="min-height:100vh;">
      <div class="container">
        <ul class="breadcrumb">
          <li><a href="/">Home</a></li>
          <li class="active">Checkout</li>
        </ul>
        <!-- BEGIN SIDEBAR & CONTENT -->
        
        <div class="row margin-bottom-40">
          <!-- BEGIN CONTENT -->
          <div class="col-md-12 col-sm-12 ">
            <h1>Checkout</h1>
            <!-- BEGIN CHECKOUT PAGE -->
            <div class="panel-group checkout-page accordion scrollable" id="checkout-page">

              <!-- BEGIN CHECKOUT -->
              <div id="checkout" class="panel panel-default">
                <div class="panel-heading">
                  <h2 class="panel-title">
                    <a data-toggle="collapse" data-parent="#checkout-page" href="#checkout-content" class="accordion-toggle">
                       ADDRESSES
                    </a>
                  </h2>
                </div>
                <div id="checkout-content" class="panel-collapse collapse in">
                  <div class="panel-body row">
                    <div class="col-md-12 col-sm-12">
                      <form action="" id="addressForm">

                        <%for(address of address){%>
                          <div class="card p-4">
                            <input type="radio" id="html" name="adressIndex" value="<%=address._id%>">
                            <label for="html"><%=address.locality%> <%=address.city%> <%=address.region%>  <%=address.country%> <%=address.post_code%> <%=address.landMark%></label><br>
                          </div>
                          <%}%>
                        </form>
                      </div>
                      <hr>
                      <button class="btn-primary" type="button" data-toggle="collapse"  data-parent="#checkout-page"  data-target="#payment-method-content">Continue</button>
                      <button class="btn-primary pull-right" type="button" data-toggle="collapse"  data-parent="#checkout-page"  data-target="#payment-address-content">add new address</button>
                    </div>
                    <div class="checkbox pull-right">
                    </div>   
                  </div>
                </div>
              
              <!-- END CHECKOUT -->

              <!-- BEGIN PAYMENT ADDRESS -->
              
              <div id="payment-address" class="panel panel-default">
                <div class="panel-heading">
                  <h2 class="panel-title">
                    <a data-toggle="collapse" data-parent="#checkout-page" href="#payment-address-content" class="accordion-toggle">
                     ADD ADDRESS
                    </a>
                  </h2>
                </div>
                <div id="payment-address-content" class="panel-collapse collapse">
                  <div class="panel-body row">
                    <div class="col-md-6 col-sm-6">
                      <h3>Your Address</h3>
                      <div class="form-group">
                        <label for="address2">Locality </label>
                        <input type="text" name="locality" id="locality" class="form-control" value="" placeholder="">
                      </div>
                      <div class="form-group">
                        <label for="city">City </label>
                        <input type="text" name="city" id="city" class="form-control" value="" placeholder="">
                      </div>
                      <div class="form-group">
                        <label for="region-state">Region/State</label>
                        <input type="text" id="region" name="region" class="form-control" value="" placeholder="">
                      </div>
                      <div class="form-group">
                        <label for="country">Country </label>
                        <input type="text" id="country" name="country" class="form-control" value="" placeholder="">
                      </div>
                      <div class="form-group">
                        <label for="post-code">Post Code</label>
                        <input type="text" id="post_code" name="post_code" class="form-control" value="" placeholder="">
                      </div>
                      <div class="form-group">
                        <label for="region-state">LandMark</label>
                        <input type="text" id="landMark" name="landMark" class="form-control" value="" placeholder="">
                      </div>
                      <label id="addressSelected" class="text-danger"></label>
                    </div>
                    <hr>
                      <button class="btn btn-primary  pull-right" type="submit" data-toggle="collapse" data-parent="#checkout-page" data-target="#coupon-address-content" onclick="checkOut(event)" id="button-payment-address">Continue</button>
                      <div class="checkbox pull-right">
                      </div>                        
                    </div>
                  </div>
                </div>
              </div>
              <!-- END PAYMENT ADDRESS -->
              
              <!-- BEGIN PAYMENT METHOD -->
              <div id="payment-method" class="panel panel-default">
                <div class="panel-heading">
                  <h2 class="panel-title">
                    <a data-toggle="collapse" data-parent="#checkout-page" href="#payment-method-content" class="accordion-toggle">
                       Payment Method
                    </a>
                  </h2>
                </div>
                <div id="payment-method-content" class="panel-collapse collapse">
                  <div class="panel-body row">
                    <div class="col-md-12">
                      <p>Please select the preferred payment method to use on this order.</p>
                      <!-- <form name="#paymentForm"> -->
                        <input type="radio" id="CashOnDelivary" name="paymentMethod" value="CashOnDelivary">
                        <label for="CashOnDelivary">Cash On Delivary</label><br>
                        <input type="radio" id="OnlineBanking" name="paymentMethod" value="OnlineBanking">
                        <label for="OnlineBanking">Online Banking</label><br>
                        <!-- </form>   -->
                        <button class="btn btn-primary  pull-right" type="submit" id="button-payment-method" data-toggle="collapse" data-parent="#checkout-page" data-target="#confirm-content">Continue</button>
                      <div class="checkbox pull-right">
                      
                      </div>  
                    </div>
                  </div>
                </div>
              </div>
              <!-- END PAYMENT METHOD -->
              <!-- coupon -->
              <div id="coupon-method" class="panel panel-default">
                <div class="panel-heading">
                  <h2 class="panel-title">
                    <a data-toggle="collapse" data-parent="#checkout-page" href="#coupon-method-content" class="accordion-toggle">
                       COUPON
                    </a>
                  </h2>
                </div>
                <div id="coupon-method-content" class="panel-collapse collapse">
                  <div class="panel-body row">
                    <div class="col-md-4">
                      <label>Enter the coupon :</label>
                      <input type="text" name="coupon" id="coupon" class="form-control" placeholder="Enter the coupon" >
                      <br>
                      <button class="btn btn-primary  pull-right" type="submit" id="couponButton" 
                          data-toggle="collapse" data-parent="#checkout-page" data-target="#confirm-content" onclick="coupon(event)" >Apply</button>
                          <label id="couponSelected" class="text-danger"></label>
                    </div>
                  </div>
                </div>
              </div>
              <!-- coupon end -->
              <!-- BEGIN CONFIRM -->
              <div id="confirm" class="panel panel-default col-12">
                <div class="panel-heading">
                  <h2 class="panel-title">
                    <a data-toggle="collapse" data-parent="#checkout-page" href="#confirm-content" class="accordion-toggle">
                       Confirm Order
                    </a>
                  </h2>
                </div>
                <div id="confirm-content" class="panel-collapse collapse">
                  <div class="panel-body row">
                    <div class="goods-data clearfix">
                      <div class="table-wrapper-responsive">
                        <table summary="Shopping cart">
                        <tr>
                          <th class="goods-page-image">Image</th>
                          <th class="goods-page-description">Name</th>
                          <th class="goods-page-ref-no">Size</th>
                          <th class="checkout-quantity">Quantity</th>
                          <th class="goods-page-quantit">Price</th>
                          <th class="goods-page-total" colspan="2">Total</th>
                        </tr>
                        <%for(data of cartData){%>
                        <tr>
                          <td class="checkout-image">
                            <a href="javascript:;"><img src="<%=data.products[0].image[0].url%>" alt="<%=data.product_Name%>"></a>
                          </td>
                          <td class="checkout-description">
                            <h3><a href="javascript:;"><%=data.product_Name%></a></h3>
                          </td>
                          <td class="checkout-model"><%=data.size%></td>
                          <td class="checkout-quantity"><%=data.quantity%></td>
                          <td class="checkout-price"><strong><span>Rs.</span><%=data.mrp%></strong></td>
                          <td class="checkout-total"><strong><span>Rs.</span><%=data.mrp*data.quantity%></strong></td>
                        </tr>
                        <%}%>
                      </table>
                      </div>
                      <div class="shopping-total">
                        <ul>
                          <li>
                            <em>Sub total</em>
                            <strong><i class="fa fa-inr"></i></strong> <strong class="price" id="subtotal" value="<%=(total)%>"><%=total%></strong>
                          </li>
                          <li>
                            <em>Discount</em>
                            <strong><i class="fa fa-inr"></i></strong><strong class="price" id="Discount">0</strong>
                          </li>
                          <li>
                            <em>Shipping cost</em>
                            <strong><i class="fa fa-inr"></i></strong><strong class="price" id="shipping"><%=total*(5/100)%></strong>
                          </li>
                          <li class="shopping-total-price">
                            <em>Total</em>
                            <strong><i class="fa fa-inr"></i></strong><strong class="price" id="total" ><%=total+(total*(5/100))%></strong>
                          </li>
                        </ul>
                      </div>
                      <div class="clearfix"></div>
                      <button class="btn btn-primary pull-right" onclick="payment(event)"  id="button-confirm">Confirm Order</button>
                      <button type="button" class="btn btn-default pull-right margin-right-20" onclick="cancel(event)">Cancel</button>
                      <label id="Noselected" class="text-danger"></label>
                    </div>
                  </div>
                </div>
              </div>
              </div>
              <!-- END CONFIRM -->
            </div>
            <!-- END CHECKOUT PAGE -->
          </div>
          <!-- END CONTENT -->
        </div>
        <!-- END SIDEBAR & CONTENT -->
      </div>
    </div>

    <!-- BEGIN STEPS -->
    
    <!-- END STEPS -->

    <!-- BEGIN PRE-FOOTER -->
    
    <!-- END PRE-FOOTER -->

    <!-- BEGIN FOOTER -->
    <%-include("./partials/footer.ejs")%>
    <!-- END FOOTER -->

    <!-- Load javascripts at bottom, this will reduce page load time -->
    <!-- BEGIN CORE PLUGINS(REQUIRED FOR ALL PAGES) -->
    <!--[if lt IE 9]>
    <script src="../userPages/plugins/respond.min.js"></script>  
    <![endif]-->
    <%-include('./partials/scripts')%>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
     function cancel(event){
        window.location = "/";
     }

    function checkOut(event){
      
      let locality=document.getElementById('locality').value
      let city=document.getElementById('city').value
      let region=document.getElementById('region').value
      let country=document.getElementById('country').value
      let post_code=document.getElementById('post_code').value
      let landMark=document.getElementById('landMark').value
      
      console.log(locality,city,region,country,post_code,landMark);
      if(locality && city &&region&&country&&post_code&&landMark){
      fetch('/checkout/addressSave',
      {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({locality,city,region,country,post_code,landMark})
      }).then(res=>res.json()).then(data=>{
        window.location = "/checkout"
        
      })
      }else{
      document.getElementById('addressSelected').innerHTML="complete the form"
    }}

    function payment(event){
      let payamentType=0
      let addressdata=document.querySelector('#addressForm')
      let addressId=addressForm.elements.adressIndex.value
      let discount=document.getElementById('Discount').innerHTML
      console.log(addressId);
      if(document.getElementById('CashOnDelivary').checked){
        payamentType =document.getElementById('CashOnDelivary').value
      }else if(document.getElementById('OnlineBanking').checked){
        payamentType=document.getElementById('OnlineBanking').value
      }else{
        payamentType=0
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Something went wrong!'
        })
        document.getElementById('Noselected').innerHTML="payment option not selected"    
      }
      console.log(payamentType)
    if(payamentType==0){
      console.log('zero')
    }
    else{
      
    let total=document.getElementById('total').innerHTML
    console.log(total)
    fetch('/checkout/order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({payamentType,total,addressId,discount})
      }).then(res=> res.json()).then(data=>{
        if(data.payamentType=="CashOnDelivary")
        {
        Swal.fire({
            icon: 'success',
            title: 'Done',
            text: 'you order registered'
        }).then(function() {
            window.location = "/";
        })
          console.log('success')
        }
        else{
          console.log(data)
          razerpayFunction(data.options, data.userDetails, data.orderId,data.order)
        }
    })
    }
  } 
    function razerpayFunction(options,userDetails,orderId,order) {
         let option = {
             "key": 'rzp_test_N8wYTR5bzHdNqv',
             "amount": options.amount,
             "currency": "INR",
             "name": "hamnas",
             "description": "MyStore Payment",
             "image": "http://localhost:5000/public/userPages/pages/img/hamnaLogo",
             "order_id": orderId,
             "handler": function (response) {
                 paymentSuccess(response,option, userDetails, orderId,order);
             },
             "prefill": {
                 "name": userDetails.name,
                 "email": userDetails.Email,
                 "contact": userDetails.Number
             },
             "notes": {
                "locality":userDetails.address[0].locality,
                "city":userDetails.address[0].city,
                "region":userDetails.address[0].region,
                "country":userDetails.address[0].country,
                "post_code":userDetails.address[0].post_code,
                "landMark":userDetails.address[0].landMark
              },
             "theme": {
                 "color": "#3399cc"
             }
         };
         let rzp1 = new Razorpay(option);
            rzp1.on('payment.failed', function (response) {
              fetch('/checkout/verify',{
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
              })
            });
            rzp1.open();
            e.preventDefault();
     } 
     function paymentSuccess(response,payDetails,userDetails,orderId,order) {
      fetch('/checkout/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({response,payDetails,userDetails,orderId,order})
      }).then(res => res.json()).then(data => {
        if(data.paymentStatus == 'success') {
        console.log(data.paymentStatus)
        Swal.fire({
            icon: 'success',
            title: 'Done',
            text: 'you order registered'
        }).then(function() {
            window.location = "/checkout/orderPage";
        })
          console.log('success')
        }else {
          Swal.fire({
            icon: 'error',
            title: 'failed',
            text: 'you order not registered'
        }).then(function() {
            window.location = "/checkout/orderPage";
        })
          console.log('fail');
        }
      });
    }

    function coupon(event){
      let couponValue=document.getElementById('coupon').value
      let subtotal=parseFloat(document.getElementById('subtotal').innerHTML)
      let shipping=parseFloat(document.getElementById('shipping').innerHTML)
      console.log("coupon",couponValue,"sub",subtotal,total);
      if(couponValue){
        fetch('/checkout/coupon', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({couponValue,subtotal})
        }).then(res => res.json()).then(data => {
          console.log(data);
          if(data.status=="success")
          {
          document.getElementById('Discount').innerHTML=data.discount
          let total=(subtotal+shipping)-data.discount
          document.getElementById('total').innerHTML=total
        }
        else if(data.status=="expire"){
          document.getElementById('couponSelected').innerHTML="coupon Expires"
        }else{
          document.getElementById('couponSelected').innerHTML="Invalid Coupon"
        }
        })
      }else{
        document.getElementById('couponSelected').innerHTML="fill Coupon"
      }
    }
    </script>

    <!-- END PAGE LEVEL JAVASCRIPTS -->
</body>
<!-- END BODY -->
</html>